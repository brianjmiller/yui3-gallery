YUI.add("gallery-model-relate",function(e,t){function s(t){var s=this;i||e.error("Cannot create relationship. ModelStore not found."),e.stamp(this),s.name=t.name,s.model=t.model,s.key=t.key||t.model.idAttribute||"id",s.relatedModel=i._getModelCtor(t.relatedModel),s.relatedKey=t.relatedKey||s.key,s.shouldBubble=t.shouldBubble||!1,t.type==="toMany"?(s.listType=t.listType||e.ModelList,e.mix(s,n,!0)):t.type==="toOne"?e.mix(s,r,!0):e.error("Cannot create relationship. "+t.type+" is not a valid relationship type."),s.init()}function a(){}var n={type:"toMany",_initRelated:function(){var t=this,n=t.listType,r={model:t.RelatedModel};e.Lang.isString(t.listType)&&(n=e.namespace(t.listType)),t.shouldBubble&&(r.bubbleTargets=[t.model]),t.related=new n(r),t._handles.push(t.related.on("remove",t._onRelatedRemove,t)),t._refreshRelationship()},_destroyRelated:function(){this.related.destroy()},_setRelated:function(e){var t=this.related,n=t.isEmpty()?"add":"reset";t[n](e)},_setRelatedAttr:function(e,t,n){this.related.each(function(r){r.set(e,t,n)})},_afterStoreAdd:function(e){var t=this,n=e.model;t._checkRelationship(n)&&(t.related.add(n,e),t.fire("add",e))},_afterStoreRemove:function(e){var t=this,n=e.model;t.related.indexOf(n)!==-1&&(t.related.remove(n,e),t.fire("remove",e))},_afterRelatedKeyChange:function(e){e.model=e.target;if(e.src==="create")return;this.related.indexOf(e.model)!==-1?(e.unregister=!0,this._afterStoreRemove(e)):this._afterStoreAdd(e)},_onRelatedRemove:function(e){!e.unregister&&!e["delete"]&&e.preventDefault()}},r={type:"toOne",_initRelated:function(){this._refreshRelationship()},_setRelated:function(t){var n=this,r;t=e.Array(t),r=t[0]||null,n.related&&(n.shouldBubble&&n.related.removeTarget(n.model),this.fire("remove",{model:n.related})),n.related=r,n.related&&(n.shouldBubble&&n.related.addTarget(n.model),this.fire("add",{model:n.related}))},_setRelatedAttr:function(e,t,n){this.related&&this.related.set(e,t,n)},_afterStoreAdd:function(e){var t=this,n=e.model;!t.related&&t._checkRelationship(n)&&t._setRelated(n)},_afterStoreRemove:function(e){var t=this,n=e.model;n===t.related&&t._refreshRelationship()},_afterRelatedKeyChange:function(e){e.model=e.target;if(e.src==="create")return;this.related===e.model?(e.unregister=!0,this._afterStoreRemove(e)):this._afterStoreAdd(e)}},i=e.ModelStore;s.toOne="toOne",s.toMany="toMany",s.prototype={type:null,related:null,init:function(e){var t=this;t._handles=[],t._storeList=i.getList(t.relatedModel),t._initRelated(),t._initEvents()},destroy:function(){this._detachEvents(),this._storeList=null,this._destroyRelated(),this._related=null},toString:function(){var t=this;return t.model.toString()+" "+t.type+" relationship "+t.name+"["+e.stamp(this,!0)+"]"},_checkRelationship:function(e){return e.get(this.relatedKey)==this.model.get(this.key)},_destroyRelated:function(){},_detachEvents:function(){e.each(this._handles,function(e){e.detach()}),this._handles=[]},_findRelated:function(t){var n=this;return e.Array.filter(n._storeList._items,n._checkRelationship,n)},_initEvents:function(){var e=this,t=e._handles,n={bubbles:!0,emitFacade:!0,prefix:"modelRelationship",preventable:!1};this.publish("add",n),this.publish("remove",n),t.push(e.model.on(e.key+"Change",e._onKeyChange,e)),t.push(e.model.after(e.key+"Change",e._afterKeyChange,e)),t.push(e._storeList.after("*:"+e.relatedKey+"Change",e._afterRelatedKeyChange,e)),t.push(e._storeList.on("error",function(e){})),t.push(e._storeList.after("add",e._afterStoreAdd,e)),t.push(e._storeList.after("remove",e._afterStoreRemove,e))},_initRelated:function(){},_refreshRelationship:function(e){this._setRelated(this._findRelated())},_setRelated:function(e){},_setRelatedAttr:function(e,t,n){},_afterKeyChange:function(e){e.src==="create"?this._setRelatedAttr(e.attrName,e.newVal,{src:"create",silent:!0}):this._refreshRelationship()},_afterStoreAdd:function(e){},_afterStoreRemove:function(e){},_afterRelatedKeyChange:function(e){},_onKeyChange:function(e){var t=e.target;e.attrName===t.idAttribute&&t.isNew()&&(e.src="create")}},e.ModelRelationship=e.augment(s,e.EventTarget);var o="relationships",u="_rel_";a.ATTRS={id:{valueFn:function(){return this.get("clientId")}},outputRelationships:{value:!1}},a.prototype={_registered:!1,initializer:function(t){var n=this,r=n._aggregateRelationships();t=t||{},n._modelRelateHandles=[e.Do.before(n._doBeforeDestroy,n,"destroy",n),e.Do.after(n._doAfterGetAttrs,n,"getAttrs",n)],e.each(r,function(t){e.each(t,n._addRelationshipAttr,n)}),n.after("initializedChange",function(e){t.register!==!1&&n.register()})},destructor:function(){var t=this._modelRelateHandles;e.each(t,function(e){e.detach()}),this._modelRelateHandles=null,this._destroyRelationships()},addRelationship:function(e,t){return this._addRelationshipAttr(t,e),this},getRelated:function(e){var t=this.getRelationship(e);return t&&t.related},getRelationship:function(e){return this.get(this._relName(e))},isNew:function(){return this.get("clientId")===this.get("id")},isRegistered:function(){return this._registered},register:function(){return!i||this.isRegistered()||(this._registered=i.registerModel(this)===this),this},removeRelationship:function(e){var t=this,n=t.getRelationship(e),r=t._relName(e);return n&&n.destroy(),t.removeAttr(r),t._state.remove(r,o),t},toString:function(){return this.name+"["+this.get("id")+":"+e.stamp(this,!0)+"]"},unregister:function(){return!i||!this.isRegistered()||(this._registered=i.unregisterModel(this)===this),this._destroyRelationships(),this},_addRelationshipAttr:function(t,n){var r=this,i=r._relName(n),s={};s.readOnly=!0,s.lazyAdd=!0,s.setter=function(t){return new e.ModelRelationship(t)},s.value=e.merge(t,{name:n,model:this}),r.addAttr(i,s,!0),r._state.get(i,"added")&&r._state.add(i,o,n)},_aggregateRelationships:function(){var e=this.constructor,t=[];while(e)e.RELATIONSHIPS&&(t[t.length]=e.RELATIONSHIPS),e=e.superclass?e.superclass.constructor:null;return t},_doAfterGetAttrs:function(){var t=this._state,n=e.Do.currentRetVal;return this.get("outputRelationships")||e.each(n,function(e,n,r){t.get(n,o)&&delete r[n]}),delete n.outputRelationships,new e.Do.AlterReturn("removed relationship meta from getAttrs return",n)},_doBeforeDestroy:function(t,n){var r;typeof t=="function"&&(n=t,t={});if(t&&(t.unregister||t["delete"]))return this.deleted=!0,r=e.bind(function(e){e?this.deleted=!1:this._destroyRelationships(),n&&n.apply(null,arguments)},this),new e.Do.AlterArgs(this.toString()+" deleted, modifying callback to destroy model relationships",[t,r])},_destroyRelationships:function(){var t=this._state.data;e.each(t,function(e,t){var n=e[o];n&&this.removeRelationship(n)},this)},_relName:function(e){return u+e}},e.ModelRelate=a},"@VERSION@");
